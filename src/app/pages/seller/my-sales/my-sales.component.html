<p-fluid class="grid grid-cols-12 gap-8">
  <!-- Botón de refrescar -->
  <div class="col-span-12 flex">
    <button type="button"
      class="bg-orange-500 hover:bg-orange-600 text-white rounded-full px-4 py-2 text-sm shadow-md flex items-center"
      (click)="refreshAll()">
      <i class="pi pi-refresh mr-2"></i> Refrescar
    </button>
  </div>

  <!-- bloque de tarjetas -->
  <div class="col-span-12 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">

    <!-- Ventas del día -->
    <div class="card flex items-center justify-between p-4 col-span-1 card-data">
      <div>
        <div class="text-sm text-gray-500">Ventas del día</div>
        <div class="text-2xl font-bold">{{ dailySales }}</div>
      </div>
      <div class="bg-blue-100 text-blue-500 rounded-full p-3">
        <i class="pi pi-calendar text-xl"></i>
      </div>
    </div>

    <!-- Ventas del mes -->
    <div class="card flex items-center justify-between p-4 col-span-1 card-data">
      <div>
        <div class="text-sm text-gray-500">Ventas del mes</div>
        <div class="text-2xl font-bold">{{ monthlySales }}</div>
      </div>
      <div class="bg-green-100 text-green-500 rounded-full p-3">
        <i class="pi pi-calendar-plus text-xl"></i>
      </div>
    </div>

    <!-- Ventas del año -->
    <div class="card flex items-center justify-between p-4 col-span-1 card-data">
      <div>
        <div class="text-sm text-gray-500">Ventas del año</div>
        <div class="text-2xl font-bold">{{ yearlySales }}</div>
      </div>
      <div class="bg-purple-100 text-purple-500 rounded-full p-3">
        <i class="pi pi-calendar text-xl"></i>
      </div>
    </div>

    <!-- Pendientes de confirmar -->
    <div class="card flex items-center justify-between p-4 col-span-1 card-data">
      <div>
        <div class="text-sm text-gray-500">Pendientes de confirmar</div>
        <div class="text-2xl font-bold">{{ pendingSales }}</div>
      </div>
      <div class="bg-yellow-100 text-yellow-500 rounded-full p-3">
        <i class="pi pi-clock text-xl"></i>
      </div>
    </div>

    <!-- Ventas canceladas -->
    <div class="card flex items-center justify-between p-4 col-span-1 card-data">
      <div>
        <div class="text-sm text-gray-500">Ventas canceladas</div>
        <div class="text-2xl font-bold">{{ canceledSales }}</div>
      </div>
      <div class="bg-red-100 text-red-500 rounded-full p-3">
        <i class="pi pi-times-circle text-xl"></i>
      </div>
    </div>

  </div>

  <div class="card col-span-12">
    <div class="font-semibold text-xl mb-4">Ventas por mes</div>

    <div class="mt-4 mb-2">
      <p-datepicker [(ngModel)]="selectedMonth" view="month" dateFormat="MM yy" [monthNavigator]="true"
        [yearNavigator]="true" yearRange="2020:2030" (onSelect)="onMonthChange($event)" [locale]="es">
      </p-datepicker>
    </div>

    <p-table [value]="orders" [paginator]="true" [rows]="10" [responsiveLayout]="'scroll'">
      <ng-template pTemplate="header">
        <tr>
          <th>Id</th>
          <th>Fecha</th>
          <th>Comprador</th>
          <th>Total</th>
          <th>Envío</th>
          <th>Estado</th>
          <th>Pago</th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-order>
        <tr>
          <td [ngClass]="getClass(order)">{{ order.id | slice:0:8 }}</td>
          <td [ngClass]="getClass(order)">{{ order.createdAt | date: 'short' }}</td>
          <td [ngClass]="getClass(order)">{{ order.buyer.name }}</td>
          <td [ngClass]="getClass(order)">{{ getTotal(order) | currency }}</td>
          <td [ngClass]="getClass(order)">{{ order.deliveryPrice | currency }}</td>
          <td [ngClass]="getClass(order)">
            <!-- Span chip con color y borde y padding -->
            <span [ngClass]="{
              'bg-green-500 border-green-500': order.status === 'CONFIRMADO',
              'bg-yellow-500 border-yellow-500': order.status === 'PENDIENTE',
              'bg-red-500 border-red-500': order.status === 'CANCELADO'
            }" class="inline-block px-2 py-1 rounded-full border text-white text-sm">
              {{ order.status }}
            </span>
          </td>
          <td [ngClass]="getClass(order)">{{ order.paymentType }}</td>
          <td [ngClass]="getClass(order)">
            <button type="button" class="p-button p-button-secondary ml-2" (click)="showOrderDetails(order)">
              <i class="pi pi-eye"></i>
            </button>
            @if (order.status === 'PENDIENTE') {
            <button type="button" class="p-button p-button-success ml-2" (click)="confirmOrder(order.id)">
              <i class="pi pi-check"></i>
            </button>
            <button type="button" class="p-button p-button-danger ml-2" (click)="openCancelOrderDialog(order)">
              <i class="pi pi-times"></i>
            </button>
            }
          </td>
        </tr>
      </ng-template>
    </p-table>

    <!-- Dialog para cancelar orden -->
    <p-dialog header="Cancelar Orden" [(visible)]="displayCancelDialog" [modal]="true" [responsive]="true"
      [style]="{ height: '500px' }">
      <ng-template pTemplate="content">
          <div class="text-center p-8 bg-white rounded-lg shadow">
            <h2 class="text-2xl mb-4">¿Por qué quieres cancelar la orden {{ orderToCancel?.id }}?</h2>
            <p-dropdown [options]="causes" [(ngModel)]="selectedCause" placeholder="Selecciona una causa"
              class="w-full mb-4"></p-dropdown>
            @if (selectedCause === 'Otro') {
            <div class="mb-4">
              <input [(ngModel)]="otherCause" type="text" placeholder="Especifica otra causa" maxlength="200"
                class="w-full p-2 border border-gray-300 rounded mb-4" />
              <small class="text-gray-500">{{ otherCause.length || 0 }}/200 caracteres</small>
            </div>
            }
            <p-button label="Cancelar orden" (onClick)="onSubmitCause()"
              [disabled]="!selectedCause || (selectedCause === 'Otro' && !otherCause)" class="w-full" />
          </div>
      </ng-template>
    </p-dialog>

    <p-dialog header="Detalles de la Orden" [(visible)]="displayDetailDialog" [modal]="true" [responsive]="true"
      [style]="{ width: '50vw' }">

      <ng-template pTemplate="content">
        <div *ngIf="selectedOrder" class="space-y-4">

          <!-- Encabezado -->
          <div class="border-b pb-2">
            <h3 class="text-lg font-semibold">
              Orden #{{ selectedOrder.id }}
            </h3>
            <p class="text-sm text-gray-500">
              Fecha: {{ selectedOrder.createdAt | date: 'short' }}
            </p>
          </div>

          <!-- Información general -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <p><strong>Comprador:</strong> {{ selectedOrder.buyer?.name || 'N/A' }}</p>
            <p><strong>Total:</strong> {{ getTotal(selectedOrder) | currency }}</p>
            <p><strong>Estado:</strong> {{ selectedOrder.status }}</p>
            <p><strong>Pago:</strong> {{ selectedOrder.paymentType }}</p>
            <p class="md:col-span-2">
              <strong>Ubicación:</strong>

              {{selectedOrder.address}}

              <google-map height="500px" width="100%" [center]="center" [zoom]="14">
                <map-marker [position]="markerPosition"></map-marker>
              </google-map>
            </p>
          </div>

          <!-- Productos -->
          <div>
            <h4 class="font-semibold mb-2">Productos</h4>
            <p-table [value]="selectedOrder.products" [paginator]="false" [rows]="5">
              <ng-template pTemplate="header">
                <tr>
                  <th>Producto</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-product>
                <tr>
                  <td>{{ product.product.name }}</td>
                  <td>{{ product.quantity }}</td>
                  <td>{{ product.product.price | currency }}</td>
                </tr>
              </ng-template>
            </p-table>
          </div>

        </div>
      </ng-template>

    </p-dialog>


  </div>

  <!-- Gráficos -->
  <div class="col-span-12 2xl:col-span-6">
    <div class="card">
      <div class="font-semibold text-xl mb-4">Ventas Mensuales últimos 6 meses <span class="text-sm text-gray-500">(Sin
          costo domicilio)</span></div>
      <p-chart type="line" [data]="lineData" [options]="lineOptions"></p-chart>
    </div>
  </div>
  <div class="col-span-12 2xl:col-span-6">
    <div class="card">
      <div class="font-semibold text-xl mb-4">Ventas por Producto de los últimos 6 meses</div>
      <p-chart type="bar" [data]="barData" [options]="barOptions"></p-chart>
    </div>
  </div>
</p-fluid>