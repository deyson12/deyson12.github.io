<app-floating-configurator />
  <div class="bg-surface-50 dark:bg-surface-950 flex items-center justify-center min-h-screen min-w-[100vw] overflow-hidden">
    <div class="flex flex-col items-center justify-center">
      <div style="border-radius:56px;padding:0.3rem;background:linear-gradient(180deg,var(--primary-color) 10%,rgba(33,150,243,0) 30%)">
        <div class="w-full bg-surface-0 dark:bg-surface-900 py-12 px-6 sm:px-12" style="border-radius:53px;min-width:min(92vw,560px)">
          
          <div class="mb-8">
            <div class="w-64 mx-auto sm:w-96">
              <img class="w-full mx-auto" src="./assets/img/logo.png" alt="Ventas 7 Lunas">
            </div>
          </div>

          @if (loading()) {
            <div class="flex flex-col items-center justify-center py-10">
              <p-progressSpinner styleClass="w-10 h-10 mb-4"></p-progressSpinner>
              <p class="text-sm text-surface-500">Validando enlace de recuperación…</p>
            </div>
          } @else {
            @if (errorMessage()) {
              <p-card styleClass="border border-red-200 bg-red-50 dark:bg-red-900/20">
                <ng-template pTemplate="title">
                  <span class="text-red-600">Enlace inválido o expirado</span>
                </ng-template>
                <p class="text-sm text-red-700 dark:text-red-300">{{ errorMessage() }}</p>
                <div class="mt-4">
                  <a routerLink="/auth/login" class="underline text-primary">Volver al inicio de sesión</a>
                </div>
              </p-card>
            } @else {
              <form [formGroup]="form" (ngSubmit)="onSubmit()" class="max-w-md mx-auto p-1">
                
                <!-- Email (solo lectura) -->
                <div class="mb-6">
                  <label for="email1" class="block text-surface-900 dark:text-surface-0 text-xl font-medium mb-2">
                    Email
                  </label>
                  <input pInputText id="email1" type="email" class="w-full mb-1" 
                         formControlName="email" [readonly]="true" />
                  <small class="text-surface-500">Se obtuvo del enlace de recuperación.</small>
                </div>

                <!-- Nueva contraseña -->
                <div class="mb-6">
                  <label for="password1" class="block text-surface-900 dark:text-surface-0 font-medium text-xl mb-2">
                    Nueva contraseña
                  </label>
                  <p-password id="password1" formControlName="password" placeholder="Nueva contraseña"
                              [toggleMask]="true" styleClass="w-full" [fluid]="true" [feedback]="false"></p-password>
                  @if (form.controls['password'].touched && form.controls['password'].invalid) {
                    <div class="text-red-600 mt-1 text-sm">
                      @if (form.controls['password'].errors?.['required']) { <span>La contraseña es obligatoria.</span> }
                      @if (form.controls['password'].errors?.['minlength']) { 
                        <span>Mínimo de {{ form.controls['password'].errors?.['minlength'].requiredLength }} caracteres.</span> 
                      }
                    </div>
                  }
                </div>

                <!-- Repetir contraseña -->
                <div class="mb-8">
                  <label for="confirm1" class="block text-surface-900 dark:text-surface-0 font-medium text-xl mb-2">
                    Repetir contraseña
                  </label>
                  <p-password id="confirm1" formControlName="confirm" placeholder="Repite la contraseña"
                              [toggleMask]="true" styleClass="w-full" [fluid]="true" [feedback]="false"></p-password>
                  @if (form.controls['confirm'].touched && form.controls['confirm'].invalid) {
                    <div class="text-red-600 mt-1 text-sm">
                      @if (form.controls['confirm'].errors?.['required']) { <span>Este campo es obligatorio.</span> }
                      @if (form.controls['confirm'].errors?.['mismatch']) { <span>Las contraseñas no coinciden.</span> }
                    </div>
                  }
                </div>

                <!-- Mensaje de error general -->
                @if (submitError()) {
                  <div class="mb-4 text-red-600 font-medium text-center">
                    {{ submitError() }}
                  </div>
                }

                <!-- Botón -->
                <p-button type="submit" label="Cambiar contraseña" styleClass="w-full" 
                          [disabled]="form.invalid || submitting()"></p-button>

                @if (submitting()) {
                  <div class="flex items-center justify-center mt-4">
                    <p-progressSpinner styleClass="w-6 h-6"></p-progressSpinner>
                  </div>
                }
              </form>

              <div class="flex justify-center mt-6">
                <a routerLink="/pages/all" class="underline">
                  <span>Volver a la tienda</span>
                </a>
              </div>
            }
          }

        </div>
      </div>
    </div>
  </div>